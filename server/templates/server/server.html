{% extends 'base.html' %}
{% block content %}
<!-- 네비게이션바 -->
{% include "navbar-server.html" %}
<!-- MAIN -->
<div class="d-grid gap-2 d-md-flex justify-content-center">
    <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSelect" aria-expanded="false" aria-controls="collapseSelect">서버 검색</button>
    <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInsert" aria-expanded="false" aria-controls="collapseInsert">서버 입력</button>
    <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUpdateMulti" aria-expanded="false" aria-controls="collapseUpdateMulti">서버 수정/삭제</button>
</div>
<!-- 검색 -->
<div class="collapse show"  id="collapseSelect" style="font-size: 12px;">
    <div class="card card-body bg-light mb-0 pb-0">

        <h6>검색란</h6>
        <table class="mb-2">
        <tr>
            <td>
                <a>- 서버명은 <font color="red"><b>=</b></font> 검색, 이외 항목은 기본적으로 <font color="red"><b>like</b></font> 검색을 제공하고 있습니다.</a>
            </td>
        </tr>
        </table>

        <table class="table table-sm text-center mb-0 pb-0" style="table-layout: fixed">
            <tr class="bg-secondary text-white">
                <th class="rounded-left">DB종류</th>
                <th class="">DB환경</th>
                <th class="">서비스명</th>
                <th class="">DB서버명</th>
                <th class="">DB버전</th>
                <th class="">감사로그</th>
                <th class="">요청 URL</th>
                <th class="rounded-right"></th>
            </tr>
            <tr>
                <form class="form-inline" onsubmit="return false" name="selectForm">
                    {% csrf_token %}
                    <td class="">
                        <div class="input-group input-group-sm">
                            <select class="custom-select" id="s_dbtype" name="s_dbtype">
                                <option value="">All</option>
                                {% if server_svr_list %}
                                {% for server_svr_lists in server_svr_list %}
                                <option {% if account_svr == server_svr_lists.dbtype %} selected {% endif %} value="{{ server_svr_lists.dbtype }}">{{ server_svr_lists.dbtype }}</option>
                                {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                    </td>
                    <td class="">
                        <div class="input-group input-group-sm">
                            <select class="custom-select" id="s_dbenv" name="s_dbenv">
                                <option value="">All</option>
                                {% if server_svr_list %}
                                {% for server_svr_lists in server_svr_list %}
                                <option {% if account_svr == server_svr_lists.dbenv %} selected {% endif %} value="{{ server_svr_lists.dbenv }}">{{ server_svr_lists.dbenv }}</option>
                                {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                    </td>
                    <td class="">
                        <input class="form-control form-control-sm" id="s_dbservice" name="s_dbservice" value="{{ dbservice }}" type="text" placeholder="">
                    </td>                                                            
                    <td class="">
                        <div class="input-group input-group-sm">
                            <select class="custom-select" id="s_dbsvr" name="s_dbsvr">
                                <option value="">All</option>
                                {% if server_svr_list %}
                                {% for server_svr_lists in server_svr_list %}
                                <option {% if account_svr == server_svr_lists.dbsvr %} selected {% endif %} value="{{ server_svr_lists.dbsvr }}">{{ server_svr_lists.dbsvr }}</option>
                                {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                    </td>
                    <td class="">
                        <input class="form-control form-control-sm" id="s_dbver" name="s_dbver" value="{{ dbver }}" type="text" placeholder="">
                    </td>
                    <td class="">
                        <input class="form-control form-control-sm" id="s_audit_yn" name="s_audit_yn" value="{{ audit_yn }}" type="text" placeholder="">
                    </td>
                    <td class="">
                        <input class="form-control form-control-sm" id="s_url" name="s_url" value="{{ url }}" type="text" placeholder="">
                    </td>
                    <td class="">
                        <button id="search" class="btn btn-secondary btn-sm">검색</button>
                    </td>
                </form>
            </tr>
        </table>
    </div>   
</div>

<!-- 결과란 -->
<div>
    {% if page is none %}
        <input id="page" name="page" type="hidden" value="1">
    {% else %}
        <input id="page" name="page" type="hidden" value="{{ page }}">
    {% endif %}

    {% if scrollHeight is none %}
        <input id="scrollHeight" name="scrollHeight" type="hidden" value="0">
    {% else %}
        <input id="scrollHeight" name="scrollHeight" type="hidden" value="{{ scrollHeight }}">
    {% endif %}
</div>
<div class="board small" id="server_list_ajax" style="font-size: 12px;"></div>

<!-- server select ajax script -->
<script>
    var token = $('input[name="csrfmiddlewaretoken"]').prop('value');

    $('#search').click(function(){
        // 검색 버튼을 누를 경우엔, page 1로 초기화
        var page = 1
        callMoreListAjax(page);
        $("#page").val(parseInt(page));
    });

    $('#server_list_ajax').load('dummy',function(){
        var page = $("#page").val();
        var scrollHeight = $("#scrollHeight").val();
        $('#myModal_sql').modal("hide");

        callMoreListAjax(page);
        $("#page").val(parseInt(page));
        $('html').animate({scrollTop: scrollHeight}, 500);
    });

    $(window).scroll(function(){
        var scrollHeight = $(window).scrollTop() + $(window).height();
        var documentHeight = $(document).height();

        if (scrollHeight + 500 >= documentHeight){
            var page = $("#page").val();
            var page_max = $("#page_max").val();
            if (parseInt(page) <= parseInt(page_max)){
                callMoreListAjax(page);
                $("#page").val(parseInt(page)+1);
            }
        }
    });

    function callMoreListAjax(page) {
        var s_dbtype = $("#s_dbtype").val();
        var s_dbenv = $("#s_dbenv").val();
        var s_dbservice = $("#s_dbservice").val();
        var s_dbsvr = $("#s_dbsvr").val();
        var s_dbver = $("#s_dbver").val();
        var s_audit_yn = $("#s_audit_yn").val();
        var s_url = $("#s_url").val();

        $.ajax( {
            type : 'POST',
            url: "{% url 'server:server_select' %}",
            async: false,
            data: {
                's_dbtype': s_dbtype,
                's_dbenv': s_dbenv,
                's_dbservice': s_dbservice,
                's_dbsvr': s_dbsvr,
                's_dbver': s_dbver,
                's_audit_yn': s_audit_yn,
                's_url': s_url,
                'page': page,
                'csrfmiddlewaretoken': token,
            },
            success: addMoreServerAjax,
            dataType: 'html'
        });
    }
</script>

<!-- common ajax script -->
<script>
    function addMoreServerAjax(data, textStatus, jqXHR) {
        $('#server_list_ajax').html(data);
    }
</script>

{% endblock %}